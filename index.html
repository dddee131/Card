<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إزالة خلفية الصور - خلفية سوداء</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: Arial, sans-serif;
        background: #2c3e50;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .container {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        max-width: 900px;
        width: 100%;
    }
    
    h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
    }
    
    .upload-area {
        border: 3px dashed #3498db;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8f9fa;
    }
    
    .upload-area:hover {
        background: #e8f4f8;
        border-color: #2980b9;
    }
    
    .upload-area.dragover {
        background: #e8f4f8;
        transform: scale(1.02);
    }
    
    #fileInput {
        display: none;
    }
    
    .upload-icon {
        font-size: 60px;
        margin-bottom: 20px;
    }
    
    .image-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
    }
    
    .image-box {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #ddd;
    }
    
    .image-box img, .image-box canvas {
        max-width: 100%;
        height: auto;
        display: block;
    }
    
    .image-label {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(52, 152, 219, 0.9);
        color: white;
        padding: 5px 15px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
    }
    
    button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16;
        margin: 10px;
        transition: all 0.3s;
    }
    
    button:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .controls {
        text-align: center;
        margin-top: 20px;
    }
    
    .settings {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .setting-group {
        margin-bottom: 20px;
    }
    
    .setting-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #333;
    }
    
    input[type="range"] {
        width: 100%;
        margin: 10px 0;
    }
    
    .slider-value {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 5px 15px;
        border-radius: 15px;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .color-options {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
    }
    
    .color-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .color-btn:hover {
        transform: scale(1.1);
    }
    
    .color-btn.active {
        border-color: #3498db;
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }
    
    .hidden {
        display: none;
    }
    
    .info-text {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 10px;
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>🎨 إزالة الخلفية وتحويلها للون الأسود</h1>

```
    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📷</div>
        <p><strong>اسحب الصورة هنا أو انقر للاختيار</strong></p>
        <p style="margin-top: 10px; font-size: 14px; color: #666;">PNG, JPG, JPEG (حد أقصى 10MB)</p>
    </div>
    
    <div class="settings hidden" id="settings">
        <div class="setting-group">
            <label>🎯 مستوى الحساسية (لتحديد الخلفية):</label>
            <input type="range" id="threshold" min="150" max="255" value="240">
            <span class="slider-value" id="thresholdValue">240</span>
            <p class="info-text">قيمة أعلى = إزالة الألوان الفاتحة فقط | قيمة أقل = إزالة المزيد من الألوان</p>
        </div>
        
        <div class="setting-group">
            <label>🎨 لون الخلفية الجديدة:</label>
            <div class="color-options">
                <div class="color-btn active" style="background: black" data-color="black"></div>
                <div class="color-btn" style="background: white" data-color="white"></div>
                <div class="color-btn" style="background: #e74c3c" data-color="#e74c3c"></div>
                <div class="color-btn" style="background: #3498db" data-color="#3498db"></div>
                <div class="color-btn" style="background: #2ecc71" data-color="#2ecc71"></div>
                <div class="color-btn" style="background: #f39c12" data-color="#f39c12"></div>
                <div class="color-btn" style="background: #9b59b6" data-color="#9b59b6"></div>
            </div>
        </div>
        
        <div class="setting-group">
            <label>✨ تنعيم الحواف:</label>
            <input type="range" id="smoothing" min="0" max="10" value="3">
            <span class="slider-value" id="smoothingValue">3</span>
        </div>
    </div>
    
    <div class="image-container hidden" id="imageContainer">
        <div class="image-box">
            <span class="image-label">الصورة الأصلية</span>
            <img id="originalImage" alt="الصورة الأصلية">
        </div>
        <div class="image-box">
            <span class="image-label">الصورة المعدلة</span>
            <canvas id="outputCanvas"></canvas>
        </div>
    </div>
    
    <div class="controls hidden" id="controls">
        <button id="processBtn">
            <span id="processText">تطبيق التعديلات</span>
        </button>
        <button id="downloadBtn" disabled>💾 تحميل الصورة</button>
        <button id="resetBtn">🔄 صورة جديدة</button>
    </div>
</div>

<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const imageContainer = document.getElementById('imageContainer');
    const originalImage = document.getElementById('originalImage');
    const outputCanvas = document.getElementById('outputCanvas');
    const controls = document.getElementById('controls');
    const settings = document.getElementById('settings');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const thresholdSlider = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    const smoothingSlider = document.getElementById('smoothing');
    const smoothingValue = document.getElementById('smoothingValue');
    const processText = document.getElementById('processText');
    
    let currentImage = null;
    let selectedColor = 'black';
    
    // Color selection
    document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedColor = btn.dataset.color;
            if (currentImage) {
                removeBackground();
            }
        });
    });
    
    // Upload functionality
    uploadArea.addEventListener('click', () => {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        };
        fileInput.click();
    });
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
    
    thresholdSlider.addEventListener('input', (e) => {
        thresholdValue.textContent = e.target.value;
        if (currentImage) {
            removeBackground();
        }
    });
    
    smoothingSlider.addEventListener('input', (e) => {
        smoothingValue.textContent = e.target.value;
        if (currentImage) {
            removeBackground();
        }
    });
    
    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('الرجاء اختيار ملف صورة');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('حجم الملف يجب أن يكون أقل من 10MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            currentImage = new Image();
            currentImage.onload = () => {
                originalImage.src = e.target.result;
                imageContainer.classList.remove('hidden');
                controls.classList.remove('hidden');
                settings.classList.remove('hidden');
                uploadArea.style.display = 'none';
                removeBackground();
            };
            currentImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    function removeBackground() {
        if (!currentImage) return;
        
        const ctx = outputCanvas.getContext('2d');
        outputCanvas.width = currentImage.width;
        outputCanvas.height = currentImage.height;
        
        // First, fill with selected background color
        ctx.fillStyle = selectedColor;
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);
        
        // Create temporary canvas for processing
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = currentImage.width;
        tempCanvas.height = currentImage.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Draw original image
        tempCtx.drawImage(currentImage, 0, 0);
        
        // Get image data
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const data = imageData.data;
        
        const threshold = parseInt(thresholdSlider.value);
        const smoothLevel = parseInt(smoothingSlider.value);
        
        // Create mask for foreground/background detection
        const mask = new Uint8Array(outputCanvas.width * outputCanvas.height);
        
        // First pass: identify background pixels (white/light backgrounds)
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // Calculate brightness
            const brightness = (r * 0.299 + g * 0.587 + b * 0.114);
            
            // Mark pixel as foreground (1) or background (0)
            const pixelIndex = i / 4;
            mask[pixelIndex] = brightness < threshold ? 1 : 0;
        }
        
        // Apply smoothing to mask edges
        if (smoothLevel > 0) {
            for (let iter = 0; iter < smoothLevel; iter++) {
                const newMask = new Uint8Array(mask);
                
                for (let y = 1; y < outputCanvas.height - 1; y++) {
                    for (let x = 1; x < outputCanvas.width - 1; x++) {
                        const idx = y * outputCanvas.width + x;
                        let sum = 0;
                        let count = 0;
                        
                        // 3x3 kernel
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nIdx = (y + dy) * outputCanvas.width + (x + dx);
                                sum += mask[nIdx];
                                count++;
                            }
                        }
                        
                        // Smooth the mask value
                        newMask[idx] = sum / count > 0.5 ? 1 : 0;
                    }
                }
                
                mask.set(newMask);
            }
        }
        
        // Final pass: draw only foreground pixels
        ctx.drawImage(currentImage, 0, 0);
        const finalData = ctx.getImageData(0, 0, outputCanvas.width, outputCanvas.height);
        const finalPixels = finalData.data;
        
        // Apply mask - keep person, replace background with selected color
        for (let i = 0; i < finalPixels.length; i += 4) {
            const pixelIndex = i / 4;
            
            if (mask[pixelIndex] === 0) {
                // This is background - replace with selected color
                const rgb = hexToRgb(selectedColor);
                finalPixels[i] = rgb.r;
                finalPixels[i + 1] = rgb.g;
                finalPixels[i + 2] = rgb.b;
                finalPixels[i + 3] = 255;
            }
            // Foreground pixels remain unchanged
        }
        
        ctx.putImageData(finalData, 0, 0);
        downloadBtn.disabled = false;
    }
    
    function hexToRgb(color) {
        if (color === 'black') return { r: 0, g: 0, b: 0 };
        if (color === 'white') return { r: 255, g: 255, b: 255 };
        
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(color);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : { r: 0, g: 0, b: 0 };
    }
    
    processBtn.addEventListener('click', () => {
        processText.innerHTML = '<span class="loading"></span>معالجة...';
        processBtn.disabled = true;
        
        setTimeout(() => {
            removeBackground();
            processText.textContent = 'تطبيق التعديلات';
            processBtn.disabled = false;
        }, 500);
    });
    
    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'edited-image.png';
        link.href = outputCanvas.toDataURL('image/png');
        link.click();
    });
    
    resetBtn.addEventListener('click', () => {
        location.reload();
    });
</script>
```

</body>
</html>
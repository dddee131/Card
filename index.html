<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø²Ø§Ù„Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙˆØ±Ø© - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .upload-section {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .upload-section.drag-over {
            border-color: #4CAF50;
            background: #f0fff0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-label {
            display: inline-block;
            padding: 12px 30px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-label:hover {
            background: #45a049;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .download-btn {
            background: #4CAF50;
        }
        
        .download-btn:hover {
            background: #45a049;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .images-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-box {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background: white;
        }
        
        .image-box h3 {
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        
        canvas {
            width: 100%;
            height: auto;
            border: 1px solid #eee;
            background-image: 
                repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 
                50% / 20px 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ Ø¥Ø²Ø§Ù„Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙˆØ±Ø© - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø©</h1>
        <p class="info">Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</p>

        <div class="upload-section" id="uploadSection">
            <label for="imageInput" class="upload-label">
                ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§
            </label>
            <input type="file" id="imageInput" accept="image/*">
            <p style="margin-top: 10px; color: #666;">PNG, JPG, JPEG, WebP</p>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...</p>
        </div>
        
        <div class="results" id="results">
            <div class="button-group">
                <button class="download-btn" onclick="downloadImage('png')">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ PNG (Ø´ÙØ§Ù)</button>
                <button class="download-btn" onclick="downloadImage('jpg')">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ JPG (Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡)</button>
            </div>
            
            <div class="images-container">
                <div class="image-box">
                    <h3>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h3>
                    <canvas id="originalCanvas"></canvas>
                </div>
                <div class="image-box">
                    <h3>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h3>
                    <canvas id="resultCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let originalImage = null;
        let processing = false;
        
        // Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const uploadSection = document.getElementById('uploadSection');
        const imageInput = document.getElementById('imageInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const originalCanvas = document.getElementById('originalCanvas');
        const resultCanvas = document.getElementById('resultCanvas');
        
        // Drag and Drop
        uploadSection.ondragover = (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        };
        
        uploadSection.ondragleave = () => {
            uploadSection.classList.remove('drag-over');
        };
        
        uploadSection.ondrop = (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        };
        
        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        };
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    displayOriginal();
                    processImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        function displayOriginal() {
            originalCanvas.width = originalImage.width;
            originalCanvas.height = originalImage.height;
            const ctx = originalCanvas.getContext('2d');
            ctx.drawImage(originalImage, 0, 0);
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        function processImage() {
            if (!originalImage || processing) return;
            
            processing = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
            }, 100);
            
            setTimeout(() => {
                processSmartRemoval();
                
                clearInterval(progressInterval);
                
                setTimeout(() => {
                    loading.style.display = 'none';
                    results.style.display = 'block';
                    processing = false;
                }, 500);
            }, 100);
        }
        
        // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©
        function processSmartRemoval() {
            const canvas = resultCanvas;
            canvas.width = originalImage.width;
            canvas.height = originalImage.height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(originalImage, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ø§Ø¨ØªØ©
            const sens = 0.5; // Ø­Ø³Ø§Ø³ÙŠØ© Ù…ØªÙˆØ³Ø·Ø©
            const smooth = 3; // ØªÙ†Ø¹ÙŠÙ… Ù…ØªÙˆØ³Ø·
            const alphaThresh = 128; // Ø¹ØªØ¨Ø© Ø´ÙØ§ÙÙŠØ© Ù…ØªÙˆØ³Ø·Ø©
            
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            const bgColor = detectBackgroundColor(data, canvas.width, canvas.height);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ù†Ø§Ø¹ Ø£Ù„ÙØ§
            const alphaMap = new Uint8Array(canvas.width * canvas.height);
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©
                const distance = colorDistance(
                    {r, g, b},
                    bgColor
                );
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
                const threshold = 100 * (1 - sens) + 30;
                let alpha = 255;
                
                if (distance < threshold) {
                    alpha = Math.max(0, Math.min(255, distance * 255 / threshold));
                }
                
                alphaMap[i / 4] = alpha;
            }
            
            // ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ù‚Ù†Ø§Ø¹
            if (smooth > 0) {
                smoothAlphaMap(alphaMap, canvas.width, canvas.height, smooth);
            }
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ù†Ø§Ø¹
            for (let i = 0; i < data.length; i += 4) {
                const alpha = alphaMap[i / 4];
                data[i + 3] = alpha < alphaThresh ? 0 : alpha;
            }
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø­ÙˆØ§Ù
            refineEdges(data, canvas.width, canvas.height);
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        
        function detectBackgroundColor(data, width, height) {
            const corners = [];
            const sampleSize = Math.min(50, width / 10, height / 10);
            
            // Ø£Ø®Ø° Ø¹ÙŠÙ†Ø§Øª Ù…Ù† Ø§Ù„Ø²ÙˆØ§ÙŠØ§ ÙˆØ§Ù„Ø­ÙˆØ§Ù
            for (let y = 0; y < sampleSize; y++) {
                for (let x = 0; x < sampleSize; x++) {
                    // Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ø£Ø±Ø¨Ø¹
                    const positions = [
                        (y * width + x) * 4,
                        (y * width + (width - 1 - x)) * 4,
                        ((height - 1 - y) * width + x) * 4,
                        ((height - 1 - y) * width + (width - 1 - x)) * 4
                    ];
                    
                    positions.forEach(idx => {
                        if (idx < data.length) {
                            corners.push({
                                r: data[idx],
                                g: data[idx + 1],
                                b: data[idx + 2]
                            });
                        }
                    });
                }
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·
            const avg = corners.reduce((acc, color) => {
                acc.r += color.r;
                acc.g += color.g;
                acc.b += color.b;
                return acc;
            }, {r: 0, g: 0, b: 0});
            
            const count = corners.length;
            return {
                r: Math.round(avg.r / count),
                g: Math.round(avg.g / count),
                b: Math.round(avg.b / count)
            };
        }
        
        function colorDistance(c1, c2) {
            const dr = c1.r - c2.r;
            const dg = c1.g - c2.g;
            const db = c1.b - c2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db);
        }
        
        function smoothAlphaMap(alphaMap, width, height, iterations) {
            for (let iter = 0; iter < iterations; iter++) {
                const temp = new Uint8Array(alphaMap);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = y * width + x;
                        let sum = 0;
                        let count = 0;
                        
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nIdx = (y + dy) * width + (x + dx);
                                sum += temp[nIdx];
                                count++;
                            }
                        }
                        
                        alphaMap[idx] = Math.round(sum / count);
                    }
                }
            }
        }
        
        function refineEdges(data, width, height) {
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const alpha = data[idx + 3];
                    
                    if (alpha > 0 && alpha < 255) {
                        // Ù…ØªÙˆØ³Ø· Ø£Ù„ÙØ§ Ø§Ù„Ø¬ÙŠØ±Ø§Ù†
                        let sum = 0;
                        let count = 0;
                        
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nIdx = ((y + dy) * width + (x + dx)) * 4;
                                sum += data[nIdx + 3];
                                count++;
                            }
                        }
                        
                        data[idx + 3] = Math.round(sum / count);
                    }
                }
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        function downloadImage(format) {
            const link = document.createElement('a');
            
            if (format === 'jpg') {
                // Ø¥Ù†Ø´Ø§Ø¡ canvas Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = resultCanvas.width;
                tempCanvas.height = resultCanvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCtx.fillStyle = '#ffffff';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(resultCanvas, 0, 0);
                
                link.download = 'removed-background.jpg';
                link.href = tempCanvas.toDataURL('image/jpeg', 0.95);
            } else {
                link.download = 'removed-background.png';
                link.href = resultCanvas.toDataURL('image/png');
            }
            
            link.click();
        }
    </script>
</body>
</html>